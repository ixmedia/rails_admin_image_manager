<% self.class.include RailsAdminImageManager::Engine.routes.url_helpers %>

function addQueryString( url, params ) {
	var queryString = [];
	if (!params) return url;
	else {
		for (var i in params) queryString.push(i + "=" + encodeURIComponent( params[i]));
	}
	return url + ( ( url.indexOf( "?" ) != -1 ) ? "&" : "?" ) + queryString.join( "&" );
}

CKEDITOR.plugins.add( 'imageManager', {
  icons: 'abbr',
  init: function( editor ) {

    editor._.insertImagefn = CKEDITOR.tools.addFunction(function(src, id, title){
  			this.insertHtml('<img src="' + src + '" data-image-id="' + id + '" />');
  		}, editor);


    editor.ui.addButton( 'imageManager', {
      label: 'Ajouter une image',
      command: 'insertImage',
      icon: "<%= asset_path 'rails_admin_image_manager/icon.png' %>"
    });

    editor.addCommand( 'insertImage', {
				exec: function(editor) {
					var params = {};
          var sel = editor.getSelection();
          if (sel.getSelectedElement() != null && sel.getSelectedElement().$.getAttribute('data-image-id')) {
            params.selectImage = sel.getSelectedElement().$.getAttribute('data-image-id');
          }
					params.CKEditor = editor.name;
					params.CKEditorFuncNum = editor._.insertImagefn;

					var url = addQueryString('<%= image_manager_index_path %>', params);
					editor.popup(url, 1024, 700);
				}
			});

  }
});

CKEDITOR.config.extraPlugins = 'imageManager';
